<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="{{ site.url }}/{{ site.baseurl }}/" />
  <title>{% if page.title %}{{ page.title }} | {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
  <meta name="description" content="{{ page.excerpt | default: site.description | strip_html | normalize_whitespace | truncate: 160 | escape }}">
  
  <!-- CSS -->
  <link rel="stylesheet" href="{{ "/css/main.css" | relative_url }}">
  
  <!-- SEO -->
  {% seo %}
</head>
<body>
  <!-- é˜…è¯»è¿›åº¦æ¡ -->
  <div id="reading-progress"></div>
  
  <!-- Header -->
  {% include header.html %}
  
  <!-- Main Content -->
  <main class="container">
    {{ content }}
  </main>
  
  <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
  <button id="back-to-top" class="back-to-top" title="è¿”å›é¡¶éƒ¨">
    â†‘
  </button>
  
  <!-- Footer -->
  {% include footer.html %}
  
  <!-- ä¸è’œå­è®¿é—®ç»Ÿè®¡ -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
  <!-- ä»£ç å¤åˆ¶åŠŸèƒ½ -->
  <script>
    // ä¸ºæ‰€æœ‰ä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®
    document.addEventListener('DOMContentLoaded', function() {
      const preBlocks = document.querySelectorAll('pre');
      
      preBlocks.forEach(pre => {
        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.className = 'code-copy-btn';
        copyBtn.textContent = 'å¤åˆ¶';
        
        // æ·»åŠ å¤åˆ¶åŠŸèƒ½
        copyBtn.addEventListener('click', function() {
          const code = pre.querySelector('code');
          if (code) {
            // è·å–ä»£ç å†…å®¹
            const codeText = code.textContent;
            
            // ä½¿ç”¨Clipboard APIå¤åˆ¶ä»£ç 
            navigator.clipboard.writeText(codeText).then(() => {
              // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
              copyBtn.textContent = 'å·²å¤åˆ¶';
              copyBtn.classList.add('copied');
              
              // 2ç§’åæ¢å¤åŸçŠ¶
              setTimeout(() => {
                copyBtn.textContent = 'å¤åˆ¶';
                copyBtn.classList.remove('copied');
              }, 2000);
            }).catch(err => {
              console.error('å¤åˆ¶å¤±è´¥:', err);
              copyBtn.textContent = 'å¤åˆ¶å¤±è´¥';
              
              setTimeout(() => {
                copyBtn.textContent = 'å¤åˆ¶';
              }, 2000);
            });
          }
        });
        
        // å°†æŒ‰é’®æ·»åŠ åˆ°ä»£ç å—ä¸­
        pre.appendChild(copyBtn);
      });
      
      // è·å–GitHub Starsæ•°é‡
      const githubStarsElement = document.getElementById('github-stars');
      if (githubStarsElement) {
        fetch('https://api.github.com/users/rabbitdeng/repos?per_page=100')
          .then(response => response.json())
          .then(repos => {
            const totalStars = repos.reduce((sum, repo) => sum + repo.stargazers_count, 0);
            githubStarsElement.textContent = totalStars;
          })
          .catch(err => {
            console.error('è·å–GitHub Starså¤±è´¥:', err);
            githubStarsElement.textContent = 'è·å–å¤±è´¥';
          });
      }
      
      // é˜…è¯»è¿›åº¦æ¡åŠŸèƒ½
      const readingProgress = document.getElementById('reading-progress');
      const backToTopBtn = document.getElementById('back-to-top');
      
      function updateReadingProgress() {
        const windowHeight = window.innerHeight;
        const docHeight = document.documentElement.scrollHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrolled = (scrollTop / (docHeight - windowHeight)) * 100;
        
        if (readingProgress) {
          readingProgress.style.width = scrolled + '%';
        }
        
        // æ§åˆ¶è¿”å›é¡¶éƒ¨æŒ‰é’®æ˜¾ç¤º
        if (backToTopBtn) {
          if (scrollTop > 300) {
            backToTopBtn.classList.add('visible');
          } else {
            backToTopBtn.classList.remove('visible');
          }
        }
      }
      
      // è¿”å›é¡¶éƒ¨åŠŸèƒ½
      function scrollToTop() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      }
      
      // è®¡ç®—é˜…è¯»æ—¶é—´
      function calculateReadingTime() {
        const content = document.querySelector('.post-content');
        if (content) {
          const wordsPerMinute = 200;
          const text = content.textContent;
          const wordCount = text.trim().split(/\s+/).length;
          const readingTime = Math.ceil(wordCount / wordsPerMinute);
          
          // æ·»åŠ é˜…è¯»æ—¶é—´åˆ°é¡µé¢
          const readingTimeElement = document.createElement('div');
          readingTimeElement.className = 'reading-time';
          readingTimeElement.innerHTML = `<span class="stats-label">é˜…è¯»æ—¶é—´ï¼š</span> ${readingTime} åˆ†é’Ÿ`;
          
          const postMeta = document.querySelector('.post-meta');
          if (postMeta) {
            postMeta.appendChild(readingTimeElement);
          }
        }
      }
      
      // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
      function initThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        
        // ä»localStorageè·å–ä¸»é¢˜åå¥½
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeIcon.textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        
        // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            // æ›´æ–°DOM
            document.documentElement.setAttribute('data-theme', newTheme);
            themeIcon.textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('theme', newTheme);
          });
        }
      }
      
      // äº‹ä»¶ç›‘å¬
      window.addEventListener('scroll', updateReadingProgress);
      if (backToTopBtn) {
        backToTopBtn.addEventListener('click', scrollToTop);
      }
      
      // åˆå§‹åŒ–
      updateReadingProgress();
      calculateReadingTime();
      initThemeToggle();
    });
  </script>
</body>
</html>