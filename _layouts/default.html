<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="{{ site.url }}/{{ site.baseurl }}/" />
  <title>{% if page.title %}{{ page.title }} | {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
  <meta name="description" content="{{ page.excerpt | default: site.description | strip_html | normalize_whitespace | truncate: 160 | escape }}">
  
  <!-- CSS -->
  <link rel="stylesheet" href="{{ "/css/main.css" | relative_url }}">
  
  <!-- SEO -->
  {% seo %}
</head>
<body>
  <!-- 阅读进度条 -->
  <div id="reading-progress"></div>
  
  <!-- Header -->
  {% include header.html %}
  
  <!-- Main Content -->
  <main class="container">
    {{ content }}
  </main>
  
  <!-- 返回顶部按钮 -->
  <button id="back-to-top" class="back-to-top" title="返回顶部">
    ↑
  </button>
  
  <!-- Footer -->
  {% include footer.html %}
  
  <!-- 不蒜子访问统计 -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
  <!-- 代码复制功能 -->
  <script>
    // 为所有代码块添加复制按钮
    document.addEventListener('DOMContentLoaded', function() {
      const preBlocks = document.querySelectorAll('pre');
      
      preBlocks.forEach(pre => {
        // 创建复制按钮
        const copyBtn = document.createElement('button');
        copyBtn.className = 'code-copy-btn';
        copyBtn.textContent = '复制';
        
        // 添加复制功能
        copyBtn.addEventListener('click', function() {
          const code = pre.querySelector('code');
          if (code) {
            // 获取代码内容
            const codeText = code.textContent;
            
            // 使用Clipboard API复制代码
            navigator.clipboard.writeText(codeText).then(() => {
              // 显示复制成功状态
              copyBtn.textContent = '已复制';
              copyBtn.classList.add('copied');
              
              // 2秒后恢复原状
              setTimeout(() => {
                copyBtn.textContent = '复制';
                copyBtn.classList.remove('copied');
              }, 2000);
            }).catch(err => {
              console.error('复制失败:', err);
              copyBtn.textContent = '复制失败';
              
              setTimeout(() => {
                copyBtn.textContent = '复制';
              }, 2000);
            });
          }
        });
        
        // 将按钮添加到代码块中
        pre.appendChild(copyBtn);
      });
      
      // 获取GitHub Stars数量
      const githubStarsElement = document.getElementById('github-stars');
      if (githubStarsElement) {
        fetch('https://api.github.com/users/rabbitdeng/repos?per_page=100')
          .then(response => response.json())
          .then(repos => {
            const totalStars = repos.reduce((sum, repo) => sum + repo.stargazers_count, 0);
            githubStarsElement.textContent = totalStars;
          })
          .catch(err => {
            console.error('获取GitHub Stars失败:', err);
            githubStarsElement.textContent = '获取失败';
          });
      }
      
      // 阅读进度条功能
      const readingProgress = document.getElementById('reading-progress');
      const backToTopBtn = document.getElementById('back-to-top');
      
      function updateReadingProgress() {
        const windowHeight = window.innerHeight;
        const docHeight = document.documentElement.scrollHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrolled = (scrollTop / (docHeight - windowHeight)) * 100;
        
        if (readingProgress) {
          readingProgress.style.width = scrolled + '%';
        }
        
        // 控制返回顶部按钮显示
        if (backToTopBtn) {
          if (scrollTop > 300) {
            backToTopBtn.classList.add('visible');
          } else {
            backToTopBtn.classList.remove('visible');
          }
        }
      }
      
      // 返回顶部功能
      function scrollToTop() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      }
      
      // 计算阅读时间功能
      function calculateReadingTime() {
        const content = document.querySelector('.post-content');
        if (content) {
          // 配置参数
          const wordsPerMinute = 200; // 中文阅读速度约为200字/分钟
          
          // 获取文章内容文本
          const text = content.textContent;
          
          // 计算字数（包括中文、英文单词和数字）
          // 中文按字符计数，英文按空格分隔的单词计数
          const chineseChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
          const englishWords = text.match(/\b[A-Za-z]+\b/g)?.length || 0;
          const totalWords = chineseChars + englishWords;
          
          // 计算阅读时间（分钟），向上取整
          const readingTime = Math.ceil(totalWords / wordsPerMinute);
          
          // 创建阅读时间元素
          const readingTimeElement = document.createElement('div');
          readingTimeElement.className = 'reading-time';
          readingTimeElement.innerHTML = `<span class="stats-label">阅读时间：</span> ${readingTime} 分钟`;
          
          // 添加到文章meta区域
          const postMeta = document.querySelector('.post-meta');
          if (postMeta) {
            postMeta.appendChild(readingTimeElement);
          }
        }
      }
      
      // 事件监听
      window.addEventListener('scroll', updateReadingProgress);
      if (backToTopBtn) {
        backToTopBtn.addEventListener('click', scrollToTop);
      }
      
      // 初始化
      updateReadingProgress();
      calculateReadingTime();
    });
  </script>
</body>
</html>